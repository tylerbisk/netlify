<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Filtering & FFT</title>

  
  <meta name="author" content="© Tyler Bisk">
  

  
  <meta name="description" content="Autonomous Maze Solving Robot Part 3">
  

  <link rel="alternate" type="application/rss+xml" title="Tyler Bisk - A portfolio of my greatest projects and achievements" href="http://localhost:4000/feed.xml">

  

  

  


  
    
      
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
       <link rel="shortcut icon" type="image/png" href="/assets/img/favico.png">
    
      <link rel="stylesheet" href="/assets/css/main.css">
       <link rel="shortcut icon" type="image/png" href="/assets/img/favico.png">
    
  

  

  

  <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="Filtering & FFT">
  

   
  <meta property="og:description" content="Autonomous Maze Solving Robot Part 3">
  


  <meta property="og:type" content="website">

  
  <meta property="og:url" content="http://localhost:4000/3400/part3">
  <link rel="canonical" href="http://localhost:4000/3400/part3">
  

  


  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@tylerbisk">
  <meta name="twitter:creator" content="@tylerbisk">

  
  <meta name="twitter:title" content="Filtering & FFT">
  

  
  <meta name="twitter:description" content="Autonomous Maze Solving Robot Part 3">
  

  

  

  

</head>


  <body>

    


    <nav class="navbar navbar-expand-md navbar-light fixed-top navbar-custom "><a class="navbar-brand" href="/">Tyler Bisk</a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/about">About Me</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cornell FSAE</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/fsae/about">about</a>
                  <a class="dropdown-item" href="/fsae/tsm">Temperature Sensing Module (2020)</a>
                  <a class="dropdown-item" href="/fsae/shutdown_box">Shutdown Box (2021)</a>
                  <a class="dropdown-item" href="/fsae/electrical_lead">Electrical Lead (2022)</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Software</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/sips">Sips</a>
                  <a class="dropdown-item" href="/freasy">Freasy</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Micro-controllers</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/zoom_buttons">Physical Zoom Buttons</a>
                  <a class="dropdown-item" href="/3400/home">Autonomous Maze-Solving Robot</a>
                  <a class="dropdown-item" href="/ece4760/lab1">Bird Song Synthesizer</a>
                  <a class="dropdown-item" href="/ece4760/lab3">PID Motor Controller</a>
                  <a class="dropdown-item" href="/ece4760/final">PIC32 Video Game</a>
            </div>
          </li>
        
          <li class="nav-item">
            <a class="nav-link" href="/resume">Resume</a>
          </li></ul>
  </div>

  

</nav>


    <!-- TODO this file has become a mess, refactor it -->







<header class="header-section ">

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="page-heading">
          <h1>Filtering & FFT</h1>
      
        
            <hr class="small">
            <span class="page-subheading">Autonomous Maze Solving Robot Part 3</span>
      
      
      
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class="container-md" role="main">
  <div class="row">
    <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <h3 id="objective">Objective</h3>
<ol>
  <li>Build a microphone with amplifier circuit and test using Matlab</li>
  <li>Use a high pass filter to generate a frequency response</li>
  <li>Generate FFTs using the Arduino</li>
</ol>

<h3 id="lt-spice">LT Spice</h3>
<p>First, we built filters using LT Spice to see how an ideal, simulated filter frequency response ought to look before diving into our own.  We used a 1.2 kOhm resistor and a 0.1 uF capacitor to simulate both a low and a high pass filter.</p>
<div align="center">
    <b>Figure 1: Schematic of the LT Spice Filters</b>
    <br />
    <img src="/assets/img/3400/lab3_lt.png" style="width: 54%" />
    <p></p>
</div>

<p>By running the circuit, we could observe the entire frequency response.  After zooming in to the -3dB frequency, it was found that the cutoff freqency for both the high pass and the low pass filter was 1.32 kHz.</p>
<div align="center">
    <b>Figures 2 and 3: Low Pass Filter with Cutoff Frequency 1.32 kHz</b>
    <br />
    <img src="/assets/img/3400/lt_lp1.png" style="width: 45%" />
    <img src="/assets/img/3400/lt_lp2.png" style="width: 53%" />
    <p></p>
</div>

<h3 id="the-microphone">The Microphone</h3>
<p>First, the microphone had to be breadboarded to the robot.  We used pin A5 on the arduino to receive the analog signal coming out of the microphone.</p>
<div align="center">
    <b>Figure 4: The Microphone Schematic</b>
    <br />
    <img src="/assets/img/3400/lab3_mic.png" style="width: 44%" />
    <p></p>
</div>
<div align="right">
[1]
</div>

<p>Instead of doing an <code class="language-plaintext highlighter-rouge">AnalogRead()</code>, which can be slow, we set up the ATMega’s ADC to convert this microphone signal to a digital signal in free run mode.  Then, the digital signal is sent over serial to MATLAB.  The baud rate must be changed to 230400 so MATLAB can receive the microphone inputs and generate a graph of intensity vs freqeuncy.  With everything connected and the correct serial port in MATLAB chosen, we then generate a 500 Hz signal while MATLAB “records” the Arduino output.  The generated graph clearly shows a spike at around 500 Hz.</p>
<div align="center">
    <b>Figure 5: The Unamplified 500 Hz Response</b>
    <br />
    <img src="/assets/img/3400/lab3_unamp.png" style="width: 74%" />
    <p></p>
</div>
<p>This signal is unamplified, which makes the noise to peak ratio fairly large, something that can be improved with the use of an operational amplifier.</p>

<h3 id="the-amplifier">The Amplifier</h3>
<p>Next, an amplifier was introduced to our microphone circuit.</p>
<div align="center">
    <b>Figure 6: The Amplification Circuit Schematic</b>
    <br />
    <img src="/assets/img/3400/lab3_amp_circuit.png" style="width: 88%" />
    <p></p>
</div>
<div align="right">
[1]
</div>

<p>The analog pin used on the arduino remained A5, the arduino was not reflashed, and the same MATLAB script was run.  However, just by amplifying the signal, the graph produced was drastically different.</p>
<div align="center">
    <b>Figure 7: The Amplified 500 Hz Response</b>
    <br />
    <img src="/assets/img/3400/lab3_amp.png" style="width: 74%" />
    <p></p>
</div>
<p>Now, since the peak intensity is 10x higher than it was before, the noise at frequncies not equal to 500 Hz is so small in comparison that it can hardly be seen, resulting in a much cleaner looking graph.</p>

<h3 id="the-high-pass-filter">The High Pass Filter</h3>
<p>Next, we added a high pass filter to our circuit.  The code on the arduino did not change, but the MATLAB script was edited to change the sound played.  Instead of a constant 500 Hz signal, we would now sweep from 100Hz to 2000Hz.  Picking the high pass filter parameters, with <code class="language-plaintext highlighter-rouge">R = 22 kOhm</code> and <code class="language-plaintext highlighter-rouge">C = 10 nF</code>, gets us a cutoff frequency of <code class="language-plaintext highlighter-rouge">723 Hz</code>.  723 Hz is right inside the working range of our 100-2000 Hz sweep.  In order to get the full frequency response H of the filter, we needed to run two sweeps: one with the filter applied (Y) and one without (X).  Then, in MATLAB, <code class="language-plaintext highlighter-rouge">H = Y./X</code>.  Then, to put it in decibles like LT Spice, <code class="language-plaintext highlighter-rouge">H_dB = 20*log(H)</code>.  Then, the smoothed H (in decibles) can finally be plotted against frequency.</p>
<div align="center">
    <b>Figure 8: The Frequency Response of our Filter vs Simulated</b>
    <br />
    <img src="/assets/img/3400/lab3_filter.png" style="width: 74%" />
    <p></p>
</div>

<p>The overlay between the high pass filter simulated using LT spice and the one obtained experimentally shows that our filter is indeed behaving as expected although much less perfect and more noisy.</p>

<h3 id="the-fft">The FFT</h3>
<p>For the final step of part 3, we want to generate FFTs using the arduino.  Now, instead of using our ADC Freerun code that has been flashed to the Arduino since the beginning of this part, we must edit it to store FFT values.</p>

<p>Instead of sending one ADC value at a time over to MATLAB, we must collect and store 257 samples.  Therefore, we have an array and an accumulator to store the raw values from the ADC.  The ADC is configured exactly as it was before: free running mode, same prescaler, etc, but instead of sampling every time the ADC is ready, we only read inside an interrupt.  We configure timer interrupts to trigger on TCA0 timeout so the values do not populate too quickly.  Then, our interrupt handler will read the ADC into our array and increment our counter.  When enough samples have been collected, we generate an FFT.  We assign an ADC value to the even entries, a zero to the odds, and throw away the first ADC value, resulting in an array of length 514.  Then, using the FFT library, we use these values to generate the actual FFT.  Since FFTs are symmetrical and we had produced 256 samples after throwing away the first one, we print out the first 128 entries of the FFT to the serial monitor.  These printed values are the entries to our FFT, completely generated by our robot!</p>

<div align="center">
    <b>Figure 9: The FFT on Serial Monitor</b>
    <br />
    <img src="/assets/img/3400/lab3_monitor.png" style="width: 74%" />
    <p></p>
</div>

<p>In order to graph these results to interpret them visually, we use MATLAB.  By assigning the Arduino’s serial output via a copy and paste to a variable, call it <code class="language-plaintext highlighter-rouge">y</code>, we can run <code class="language-plaintext highlighter-rouge">stem(y)</code> and generate a beautiful FFT plot of the data.</p>

<p>The interrupts are enabled and samples are collected right when the Arduino boots up, so we must be sure to be playing a signal when the reset button on the Arduino is pressed.</p>

<div align="center">
    <b>Figure 10: Nano-Generated FFT of 500 Hz Signal</b>
    <br />
    <img src="/assets/img/3400/lab3_fft5.png" style="width: 74%" />
    <p></p>
</div>

<div align="center">
    <b>Figure 11: Nano-Generated FFT of 700 Hz Signal</b>
    <br />
    <img src="/assets/img/3400/lab3_fft7.png" style="width: 74%" />
    <p></p>
</div>

<div align="center">
    <b>Figure 12: Nano-Generated FFT of 900 Hz Signal</b>
    <br />
    <img src="/assets/img/3400/lab3_fft9.png" style="width: 74%" />
    <p></p>
</div>

<h3 id="wrapping-up">Wrapping Up</h3>
<p>Here are a couple photos of our robot with the microphone, the amplifier, and the high pass circuitry all included.</p>

<div align="center">
    <b>Figure 13: Breadboard Closeup</b>
    <br />
    <img src="/assets/img/3400/lab3_bb.jpg" style="width: 74%" />
    <p></p>
</div>
<div align="center">
    <b>Figure 14: The Completed Part 3 Robot</b>
    <br />
    <img src="/assets/img/3400/lab3_robot.jpg" style="width: 74%" />
    <p></p>
</div>

<h3 id="resources">Resources</h3>
<p>[1] C. Poitras, <em>Filtering &amp; FFT</em>, ECE 3400, October 13, 2021.</p>

      
    </div>
  </div>
</div>


    <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="mailto:tyler07039@gmail.com" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/tylerbisk" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://twitter.com/tylerbisk" title="Twitter">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Twitter</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://linkedin.com/in/tylerbisk" title="LinkedIn">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">LinkedIn</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        © Tyler Bisk
        &nbsp;&bull;&nbsp;
      
      2022

      

      
      </p>
      <!-- Add a second line to the footer -->
      <p class="theme-by text-muted">

      </p>
      </div>
    </div>
  </div>
</footer>


    
  
    
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>


  
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>


  
    
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/main.js"></script>
    
  







  </body>
</html>
